!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","lodash","moment","angular","@fullcalendar/core","@fullcalendar/moment","@fullcalendar/moment-timezone","@fullcalendar/daygrid","@fullcalendar/timegrid","@fullcalendar/list","fullcalendar/customView","angular-material","moment-range","stratus.services.iCal"],factory):factory(root.Stratus,root._,root.moment,root.angular)}(this,function(Stratus,_,moment,angular,fullcalendarCore,momentPlugin,momentTimezonePlugin,fullcalendarDayGridPlugin,fullcalendarTimeGridPlugin,fullcalendarListPlugin,fullcalendarCustomViewPlugin){const min=Stratus.Environment.get("production")?".min":"";Stratus.Components.Calendar={transclude:!0,bindings:{elementId:"@",options:"@"},controller:function($scope,$attrs,$element,$sce,$mdPanel,$mdDialog,$http,$compile,iCal){const $ctrl=this;$ctrl.uid=_.uniqueId(_.camelToSnake("calendar")+"_"),Stratus.Instances[$ctrl.uid]=$scope,$scope.elementId=$attrs.elementId||$ctrl.uid,Stratus.Internals.CssLoader(`${Stratus.BaseUrl}${Stratus.BundlePath}extras/components/calendar/calendar${min}.css`),$scope.initialized=!1,$scope.calendarId=$scope.elementId+"_fullcalendar",$scope.calendar=null,$scope.calendarEl=null,$scope.options=$attrs.options&&_.isJSON($attrs.options)?JSON.parse($attrs.options):{},$scope.options.customButtons=$scope.options.customButtons||null,$scope.options.buttonIcons=$scope.options.buttonIcons||{prev:"left-single-arrow",next:"right-single-arrow",prevYear:"left-double-arrow",nextYear:"right-double-arrow"};$scope.options.buttonText=_.extend({},{today:"today",dayGridMonth:"month",listMonth:"month list",timeGridWeek:"week agenda",dayGridWeek:"week",listWeek:"week list",timeGridDay:"day agenda",dayGridDay:"day",listDay:"day list",listYear:"year",customArticleDay:"article",customArticleWeek:"article",customArticleMonth:"article",customArticleYear:"article"},$scope.options.buttonText),$scope.options.defaultView=$scope.options.defaultView||"dayGridMonth",$scope.options.possibleViews=$scope.options.possibleViews||["dayGridMonth","timeGridWeek","timeGridDay"],$scope.options.defaultDate=$scope.options.defaultDate||null,$scope.options.nowIndicator=$scope.options.nowIndicator||!1,$scope.options.timeZone=$scope.options.timeZone||"local",$scope.options.eventForceAllDay=$scope.options.eventForceAllDay||!1,$scope.options.eventLimit=$scope.options.eventLimit||7,$scope.options.eventLimitClick=$scope.options.eventLimitClick||"popover",$scope.options.fixedWeekCount=$scope.options.fixedWeekCount||!1,$scope.options.firstDay=$scope.options.firstDay||0,$scope.options.weekends=$scope.options.weekends||!0,$scope.options.hiddenDays=$scope.options.hiddenDays||[],$scope.options.weekNumbers=$scope.options.weekNumbers||!1,$scope.options.weekNumberCalculation=$scope.options.weekNumberCalculation||"local",$scope.options.businessHours=$scope.options.businessHours||!1,$scope.options.RTL=$scope.options.RTL||!1,$scope.options.height=$scope.options.height||null,$scope.options.contentHeight=$scope.options.contentHeight||null,$scope.options.aspectRatio=$scope.options.aspectRatio||1.35,$scope.options.handleWindowResize=$scope.options.handleWindowResize||!0,$scope.options.windowResizeDelay=$scope.options.windowResizeDelay||100,$scope.options.eventSources=$scope.options.eventSources||[],$scope.options.plugins=[momentPlugin.default,momentTimezonePlugin.default,fullcalendarDayGridPlugin.default,fullcalendarTimeGridPlugin.default,fullcalendarListPlugin.default,fullcalendarCustomViewPlugin.default],$scope.initialized=!1,$scope.fetched=!1,$scope.startRange=moment(),$scope.endRange=moment(),$scope.customViews={},Stratus.Internals.CssLoader(`${Stratus.BaseUrl}${Stratus.BundlePath}node_modules/@fullcalendar/core/main${min}.css`),$scope.options.possibleViews.some(r=>["dayGrid","dayGridDay","dayGridWeek","dayGridMonth"].includes(r))&&Stratus.Internals.CssLoader(`${Stratus.BaseUrl}${Stratus.BundlePath}node_modules/@fullcalendar/daygrid/main${min}.css`),$scope.options.possibleViews.some(r=>["timeGrid","timeGridDay","timeGridWeek"].includes(r))&&Stratus.Internals.CssLoader(`${Stratus.BaseUrl}${Stratus.BundlePath}node_modules/@fullcalendar/timegrid/main${min}.css`),$scope.options.possibleViews.some(r=>["list","listDay","listWeek","listMonth","listYear"].includes(r))&&Stratus.Internals.CssLoader(`${Stratus.BaseUrl}${Stratus.BundlePath}node_modules/@fullcalendar/list/main${min}.css`),$ctrl.$onInit=function(){$ctrl.prepareHeader(),setTimeout(async function(){try{Stratus.Environment.get("production")||console.log("loading external urls:",$scope.options.eventSources),await $ctrl.render(),await Promise.all($scope.options.eventSources.map(url=>$scope.addEventICSSource(url))),Stratus.Environment.get("production")||console.log("completed loading events:",arguments),$scope.$applyAsync(function(){$scope.initialized=!0})}catch(e){console.error("calendar render:",e)}},1)},$scope.addEventICSSource=async function(url){let fullUrl=url;fullUrl.startsWith("http")&&(fullUrl=`https://cors-anywhere.herokuapp.com/${url}`);let response=await $http.get(fullUrl);Stratus.Environment.get("production")||console.log("fetched the events from:",url);const events=new iCal.ICalExpander(response.data,{maxIterations:0}).jsonEventsForFullCalendar(new Date("2018-01-24T00:00:00.000Z"),new Date("2020-01-26T00:00:00.000Z"));return $scope.calendar.addEventSource({events:events}),events},$scope.handleEventClick=function(clickEvent){return $scope.displayEventDialog(clickEvent.event,clickEvent.jsEvent),!1},$scope.displayEventDialog=function(calEvent,clickEvent){$mdDialog.show({templateUrl:`${Stratus.BaseUrl}${Stratus.BundlePath}extras/components/calendar/eventDialog${min}.html`,parent:angular.element(document.body),targetEvent:clickEvent,clickOutsideToClose:!0,escapeToClose:!1,fullscreen:!0,locals:{eventData:calEvent},bindToController:!0,controllerAs:"ctrl",controller:function(){let dc=this,close=function(){$mdDialog&&$mdDialog.hide()};dc.$onInit=function(){dc.timeZone="",dc.eventData&&dc.eventData._calendar&&dc.eventData._calendar.dateEnv&&"local"!==dc.eventData._calendar.dateEnv.timeZone&&(dc.timeZone=dc.eventData._calendar.dateEnv.timeZone),dc.eventData&&!dc.eventData.descriptionHTML&&dc.eventData.constructor.prototype.hasOwnProperty("extendedProps")&&dc.eventData.extendedProps.hasOwnProperty("description")&&(dc.eventData.descriptionHTML=$sce.trustAsHtml(dc.eventData.extendedProps.description)),dc.close=close}}})},$ctrl.prepareHeader=function(){if($scope.options.header)return;let headerRight="month,weekGrid,dayGrid";_.isArray($scope.options.possibleViews)&&(headerRight=$scope.options.possibleViews.join(",")),$scope.options.header={left:"prev,next today",center:"title",right:headerRight}},$ctrl.render=function(){return $scope.calendarEl=document.getElementById($scope.calendarId),$scope.calendar=new fullcalendarCore.Calendar($scope.calendarEl,{$scope:$scope,$compile:$compile,$sce:$sce,plugins:$scope.options.plugins,header:$scope.options.header,defaultView:$scope.options.defaultView,defaultDate:$scope.options.defaultDate,nowIndicator:$scope.options.nowIndicator,timeZone:$scope.options.timeZone,eventLimit:$scope.options.eventLimit,eventLimitClick:$scope.options.eventLimitClick,buttonText:$scope.options.buttonText,customButtons:$scope.options.customButtons,fixedWeekCount:$scope.options.fixedWeekCount,firstDay:$scope.options.firstDay,weekends:$scope.options.weekends,hiddenDays:$scope.options.hiddenDays,weekNumbers:$scope.options.weekNumbers,weekNumberCalculation:$scope.options.weekNumberCalculation,businessHours:$scope.options.businessHours,isRTL:$scope.options.RTL,height:$scope.options.height,contentHeight:$scope.options.contentHeight,aspectRatio:$scope.options.aspectRatio,handleWindowResize:$scope.options.handleWindowResize,windowResizeDelay:$scope.options.windowResizeDelay,eventClick:$scope.handleEventClick}),$scope.calendar.render(),$scope.calendar}},template:'<div id="{{ elementId }}"><md-progress-linear md-mode="indeterminate" data-ng-if="!initialized"></md-progress-linear><div id="{{ calendarId }}"></div></div>'}});