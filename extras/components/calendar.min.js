!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","jquery","moment","angular","fullcalendar","stratus.components.calendar.timezones","angular-material","moment-range","stratus.services.iCal"],factory):factory(root.Stratus,root._,root.jQuery,root.moment,root.angular)}(this,function(Stratus,_,jQuery,moment,angular,fullcalendar,timezones){const min=Stratus.Environment.get("production")?".min":"";Stratus.Components.Calendar={transclude:!0,bindings:{elementId:"@",options:"@"},controller:function($scope,$attrs,$element,$sce,$mdPanel,$mdDialog,iCal){const $ctrl=this;$ctrl.uid=_.uniqueId(_.camelToSnake("calendar")+"_"),Stratus.Instances[$ctrl.uid]=$scope,$scope.elementId=$attrs.elementId||$ctrl.uid,Stratus.Internals.CssLoader(Stratus.BaseUrl+Stratus.BundlePath+"extras/components/calendar"+min+".css"),$scope.initialized=!1,$scope.calendarId=$scope.elementId+"_fullcalendar",Stratus.Internals.CssLoader(Stratus.BaseUrl+Stratus.BundlePath+"bower_components/fullcalendar/dist/fullcalendar"+min+".css"),$scope.options=$attrs.options&&_.isJSON($attrs.options)?JSON.parse($attrs.options):{},$scope.options.customButtons=$scope.options.customButtons||null,$scope.options.buttonIcons=$scope.options.buttonIcons||{prev:"left-single-arrow",next:"right-single-arrow",prevYear:"left-double-arrow",nextYear:"right-double-arrow"};$scope.options.buttonText=_.extend({},{today:"today",month:"month",listMonth:"month list",agendaWeek:"week agenda",basicWeek:"week",listWeek:"week list",agendaDay:"day agenda",basicDay:"day",listDay:"day list",listYear:"year"},$scope.options.buttonText),$scope.options.defaultView=$scope.options.defaultView||"month",$scope.options.possibleViews=$scope.options.possibleViews||["month","weekAgenda","dayAgenda"],$scope.options.defaultDate=$scope.options.defaultDate||null,$scope.options.nowIndicator=$scope.options.nowIndicator||!1,$scope.options.timezone=$scope.options.timezone||!1,$scope.options.eventForceAllDay=$scope.options.eventForceAllDay||!1,$scope.options.eventLimit=$scope.options.eventLimit||7,$scope.options.eventLimitClick=$scope.options.eventLimitClick||"popover",$scope.options.fixedWeekCount=$scope.options.fixedWeekCount||!1,$scope.options.firstDay=$scope.options.firstDay||0,$scope.options.weekends=$scope.options.weekends||!0,$scope.options.hiddenDays=$scope.options.hiddenDays||[],$scope.options.weekNumbers=$scope.options.weekNumbers||!1,$scope.options.weekNumberCalculation=$scope.options.weekNumberCalculation||"local",$scope.options.businessHours=$scope.options.businessHours||!1,$scope.options.RTL=$scope.options.RTL||!1,$scope.options.height=$scope.options.height||null,$scope.options.contentHeight=$scope.options.contentHeight||null,$scope.options.aspectRatio=$scope.options.aspectRatio||1.35,$scope.options.handleWindowResize=$scope.options.handleWindowResize||!0,$scope.options.windowResizeDelay=$scope.options.windowResizeDelay||100,$scope.options.eventSources=$scope.options.eventSources||[],$scope.initialized=!1,$scope.fetched=!1,$scope.startRange=moment(),$scope.endRange=moment(),$ctrl.$onInit=function(){iCal.registerTimezones(timezones),$ctrl.prepareHeader(),setTimeout(async function(){Stratus.Environment.get("production")||console.log("loading external urls:",$scope.options.eventSources);try{await Promise.all(_.union([$ctrl.render()],$scope.options.eventSources.map(url=>$scope.addEventICSSource(url)))).then(function(){Stratus.Environment.get("production")||console.log("completed loading events:",arguments),$scope.initialized=!0})}catch(e){console.error("calendar render:",e)}},1)},$scope.addEventICSSource=async function(url){return new Promise(function(resolve){jQuery.get(`https://cors-anywhere.herokuapp.com/${url}`,function(urlResponse){Stratus.Environment.get("production")||console.log("fetched the events from:",url);const events=new iCal.ICalExpander(urlResponse,{maxIterations:0}).jsonEventsForFullCalendar(new Date("2018-01-24T00:00:00.000Z"),new Date("2020-01-26T00:00:00.000Z"));jQuery("#"+$scope.calendarId).fullCalendar("addEventSource",{events:events}),resolve(events)})})},$scope.handleEventClick=async function(calEvent,jsEvent,view){return $scope.displayEventDialog(calEvent,jsEvent,view),!1},$scope.displayEventDialog=async function(calEvent,clickEvent){$mdDialog.show({templateUrl:Stratus.BaseUrl+"sitetheorystratus/stratus/components/calendar.eventDialog"+min+".html",parent:angular.element(document.body),targetEvent:clickEvent,clickOutsideToClose:!0,escapeToClose:!1,fullscreen:!0,locals:{eventData:calEvent},bindToController:!0,controllerAs:"ctrl",controller:function($scope,$mdDialog){let dc=this;function close(){$mdDialog&&$mdDialog.hide()}dc.$onInit=function(){dc.eventData&&dc.eventData.hasOwnProperty("description")&&(dc.eventData.descriptionHTML=$sce.trustAsHtml(dc.eventData.description)),dc.close=close}}})},$ctrl.prepareHeader=function(){if($scope.options.header)return;let headerRight="month,agendaWeek,agendaDay";_.isArray($scope.options.possibleViews)&&(headerRight=$scope.options.possibleViews.join(",")),$scope.options.header={left:"prev,next today",center:"title",right:headerRight}},$ctrl.render=function(){return new Promise(function(resolve){jQuery("#"+$scope.calendarId).fullCalendar({buttonText:$scope.options.buttonText,customButtons:$scope.options.customButtons,buttonIcons:$scope.options.buttonIcons,header:$scope.options.header,defaultView:$scope.options.defaultView,defaultDate:$scope.options.defaultDate,nowIndicator:$scope.options.nowIndicator,timezone:$scope.options.timezone,eventLimit:$scope.options.eventLimit,eventLimitClick:$scope.options.eventLimitClick,fixedWeekCount:$scope.options.fixedWeekCount,firstDay:$scope.options.firstDay,weekends:$scope.options.weekends,hiddenDays:$scope.options.hiddenDays,weekNumbers:$scope.options.weekNumbers,weekNumberCalculation:$scope.options.weekNumberCalculation,businessHours:$scope.options.businessHours,isRTL:$scope.options.RTL,height:$scope.options.height,contentHeight:$scope.options.contentHeight,aspectRatio:$scope.options.aspectRatio,handleWindowResize:$scope.options.handleWindowResize,windowResizeDelay:$scope.options.windowResizeDelay,eventClick:$scope.handleEventClick,viewRender:function(view){resolve()}})})}},template:'<div id="{{ elementId }}"><div id="{{ calendarId }}"></div></div>'}});