!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","lodash","jquery","angular","froala","stratus.services.model","codemirror/mode/htmlmixed/htmlmixed","codemirror/addon/edit/matchbrackets","codemirror","froala-align","froala-code-beautifier","froala-code-view","froala-draggable","froala-entities","froala-file","froala-forms","froala-fullscreen","froala-help","froala-image","froala-image-manager","froala-inline-style","froala-link","froala-lists","froala-paragraph-format","froala-paragraph-style","froala-quick-insert","froala-quote","froala-table","froala-url","froala-video","froala-word-paste"],factory):factory(root.Stratus,root._,root.$,root.angular)}(this,function(Stratus,_,$,angular){Stratus.Directives.Froala=["Model",function(Model){"use strict";let generatedIds=0;const defaultConfig={immediateAngularModelUpdate:!1,angularIgnoreAttrs:null},froalaConfig=angular.module("stratusApp").value("froalaConfig")||{};let SPECIAL_TAGS=["img","button","input","a"];return{restrict:"A",require:"ngModel",scope:{ngModel:"=",property:"@",froalaOptions:"=stratusFroala",staticOptions:"@froalaOptions",initFunction:"&froalaInit",autoSave:"@"},link:function(scope,element,attrs,ngModel){if(scope.uid=this.uid=_.uniqueId("froala_"),Stratus.Instances[this.uid]=scope,scope.model=null,!ngModel||!scope.property)return void console.warn(scope.uid+" has no model or property!");element=element.length?$(element[0]):element;let specialTag=!1;-1!==SPECIAL_TAGS.indexOf(element.prop("tagName").toLowerCase())&&(specialTag=!0);let ctrl={editorInitialized:!1};if(scope.staticOptions&&"string"==typeof scope.staticOptions&&(scope.staticOptions=JSON.parse(scope.staticOptions)),scope.initMode=attrs.froalaInit?"manual":"automatic",scope.settle=function(){ctrl.editorInitialized&&scope.model instanceof Model&&scope.property&&scope.model.get(scope.property)!==scope.value&&(scope.model.set(scope.property,scope.value),scope.$root.$$phase||scope.$apply())},scope.accept=function(){ctrl.editorInitialized&&scope.model instanceof Model&&scope.property&&!0===scope.model.changed&&scope.model.throttleSave()},ctrl.init=function(){attrs.id||attrs.$set("id","froala-"+generatedIds++),scope.$watch("model.data."+scope.property,function(data){scope.value=data,ngModel.$render()}),"automatic"===scope.initMode&&ctrl.createEditor(),ngModel.$render=function(){if(ctrl.editorInitialized)if(specialTag){let tags=scope.value;if(tags){for(let attr in tags)tags.hasOwnProperty(attr)&&"innerHTML"!==attr&&element.attr(attr,tags[attr]);tags.hasOwnProperty("innerHTML")&&(element[0].innerHTML=tags.innerHTML)}}else element.froalaEditor("html.get")!==scope.value&&(element.froalaEditor("html.set",scope.value||"",!0),element.froalaEditor("undo.reset"),element.froalaEditor("undo.saveStep"))},ngModel.$isEmpty=function(value){return!value||element.froalaEditor("node.isEmpty",$("<div>"+value+"</div>").get(0))}},ctrl.createEditor=function(froalaInitOptions){if(ctrl.listeningEvents=["froalaEditor"],!ctrl.editorInitialized){froalaInitOptions=froalaInitOptions||{},ctrl.options=angular.extend({},defaultConfig,froalaConfig,scope.froalaOptions,scope.staticOptions,froalaInitOptions),ctrl.options.immediateAngularModelUpdate&&ctrl.listeningEvents.push("keyup");let flushNgModel=function(){ctrl.editorInitialized=!0,ngModel.$render()};specialTag?flushNgModel():ctrl.registerEventsWithCallbacks("froalaEditor.initialized",function(){flushNgModel()});for(let eventName in ctrl.options.events)ctrl.options.events.hasOwnProperty(eventName)&&ctrl.registerEventsWithCallbacks(eventName,ctrl.options.events[eventName]);ctrl.froalaElement=element.froalaEditor(ctrl.options).data("froala.editor").$el,ctrl.froalaEditor=angular.bind(element,element.froalaEditor),ctrl.initListeners(),scope.froalaOptions&&(scope.froalaOptions.froalaEditor=ctrl.froalaEditor)}},ctrl.initListeners=function(){ctrl.options.immediateAngularModelUpdate&&ctrl.froalaElement.on("keyup",function(){scope.$evalAsync(ctrl.updateModelView)}),element.on("froalaEditor.contentChanged",function(){scope.$evalAsync(ctrl.updateModelView)}),element.bind("$destroy",function(){element.off(ctrl.listeningEvents.join(" ")),element.froalaEditor("destroy"),element=null}),!1!==scope.autoSave&&"false"!==scope.autoSave&&element.froalaEditor("events.on","blur",function(event){if(ctrl.editorInitialized)switch(event.type){case"focusout":case"blur":scope.$apply(scope.accept)}})},ctrl.updateModelView=function(){let modelContent=null;if(specialTag){let attributeNodes=element[0].attributes,attrs={};for(let i=0;i<attributeNodes.length;i++){let attrName=attributeNodes[i].name;ctrl.options.angularIgnoreAttrs&&-1!==ctrl.options.angularIgnoreAttrs.indexOf(attrName)||(attrs[attrName]=attributeNodes[i].value)}element[0].innerHTML&&(attrs.innerHTML=element[0].innerHTML),modelContent=attrs}else{let returnedHtml=element.froalaEditor("html.get");angular.isString(returnedHtml)&&(modelContent=returnedHtml)}scope.value=modelContent,scope.settle()},ctrl.registerEventsWithCallbacks=function(eventName,callback){eventName&&callback&&(ctrl.listeningEvents.push(eventName),element.on(eventName,callback))},"manual"===scope.initMode){let _ctrl=ctrl,controls={initialize:ctrl.createEditor,destroy:function(){_ctrl.froalaEditor&&(_ctrl.froalaEditor("destroy"),_ctrl.editorInitialized=!1)},getEditor:function(){return _ctrl.froalaEditor?_ctrl.froalaEditor:null}};scope.initFunction({initControls:controls})}scope.$watch("ngModel",function(data){if(data instanceof Model&&!_.isEqual(data,scope.model)&&(scope.model=data,!0!==ctrl.initialized)){let unwatch=scope.$watch("model.data",function(dataCheck){void 0!==dataCheck&&(unwatch(),ctrl.init())})}})}}}],Stratus.Directives.FroalaView=["$sce",function($sce){return{restrict:"ACM",scope:!1,link:function(scope,element,attrs){element.addClass("fr-view"),scope.$watch(attrs.froalaView,function(nv){if(nv||""===nv){let explicitlyTrustedValue=$sce.trustAsHtml(nv);element.html(explicitlyTrustedValue.toString())}})}}}]});