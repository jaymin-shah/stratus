!function(t,e){"function"==typeof define&&define.amd?define(["stratus","ical"],e):e(t.Stratus)}(this,function(t,e,n){t.Services.iCal=["$provide",function(t){t.factory("iCal",[function(){const t=function(t,e){e=e||{},this.maxIterations=null!=e.maxIterations?e.maxIterations:1e3,this.skipInvalidDates=null!=e.skipInvalidDates&&e.skipInvalidDates,this.jCalData=ICAL.parse(t),this.component=new ICAL.Component(this.jCalData),this.events=this.component.getAllSubcomponents("vevent").map(t=>new ICAL.Event(t)),this.skipInvalidDates&&(this.events=this.events.filter(t=>{try{return t.startDate.toJSDate(),t.endDate.toJSDate(),!0}catch(t){return!1}}))};return t.prototype.between=function(t,e){const n=function(n,r){return(!t||r>=t.getTime())&&(!e||n<=e.getTime())},r=function(t){const e=t.startDate.toJSDate().getTime();let n=t.endDate.toJSDate().getTime();return t.endDate.isDate&&n>e&&(n-=1),{startTime:e,endTime:n}},a=[];this.events.forEach(t=>{t.isRecurrenceException()&&a.push(t)});const i={events:[],occurrences:[]};return this.events.filter(t=>!t.isRecurrenceException()).forEach(t=>{const o=[];if(t.component.getAllProperties("exdate").forEach(t=>{const e=t.getFirstValue();o.push(e.toJSDate().getTime())}),t.isRecurring()){const s=t.iterator();let c,u=0;do{if(u+=1,c=s.next()){const s=t.getOccurrenceDetails(c),{startTime:u,endTime:l}=r(s),m=-1!==o.indexOf(u),p=a.find(e=>e.uid===t.uid&&e.recurrenceId.toJSDate().getTime()===s.startDate.toJSDate().getTime());if(e&&u>e.getTime())break;n(u,l)&&(p?i.events.push(p):m||i.occurrences.push(s))}}while(c&&(!this.maxIterations||u<this.maxIterations));return}const{startTime:s,endTime:c}=r(t);n(s,c)&&i.events.push(t)}),i},t.prototype.before=function(t){return this.between(void 0,t)},t.prototype.after=function(t){return this.between(t)},t.prototype.all=function(){return this.between()},t.prototype.flattenRecurringEvent=function(t){let e=this.flattenEvent(t.item);return e.recurrenceId=t.recurrenceId.toJSDate(),e.startDate=t.startDate.toJSDate(),e.endDate=t.endDate.toJSDate(),e},t.prototype.flattenEvent=function(t){return{startDate:t.startDate.toJSDate(),endDate:t.endDate.toJSDate(),description:t.description,title:t.summary,summary:t.summary,attendees:t.attendees,organizer:t.organizer,sequence:t.sequence,uid:t.uid,location:t.location,url:t.url,allDay:t.allDay,image:t.image}},t.prototype.jsonEvents=function(t,e){let n;const r=(n=t&&e?this.between(t,e):this.all()).events.map(t=>this.flattenEvent(t)),a=n.occurrences.map(t=>this.flattenRecurringEvent(t));return[].concat(r,a)},t.prototype.flattenRecurringEventForFullCalendar=function(t){let e=this.flattenEventForFullCalendar(t.item);return e.start=t.startDate.toJSDate(),e.end=t.endDate.toJSDate(),e},t.prototype.flattenEventForFullCalendar=function(t){return{start:t.startDate.toJSDate(),end:t.endDate.toJSDate(),title:t.summary,summary:t.summary,description:t.description,attendees:t.attendees,organizer:t.organizer,id:t.uid,location:t.location,url:t.url,allDay:t.allDay,image:t.image}},t.prototype.jsonEventsForFullCalendar=function(t,e){let n;const r=(n=t&&e?this.between(t,e):this.all()).events.map(t=>this.flattenEventForFullCalendar(t)),a=n.occurrences.map(t=>this.flattenRecurringEventForFullCalendar(t));return[].concat(r,a)},{ICalExpander:t,registerTimezones:function(t){Object.keys(t).forEach(e=>{const n=t[e],r=ICAL.parse(`BEGIN:VCALENDAR\nPRODID:-//tzurl.org//NONSGML Olson 2012h//EN\nVERSION:2.0\n${n}\nEND:VCALENDAR`),a=new ICAL.Component(r).getFirstSubcomponent("vtimezone");ICAL.TimezoneService.register(a)})}}}])}]});