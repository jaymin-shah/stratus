!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","lodash","angular","moment","angular-sanitize","angular-material","stratus.services.propertyLoopback","stratus.components.propertyMemberDetails"],factory):factory(root.Stratus,root._,root.angular,root.moment)}(this,function(Stratus,_,angular,moment){const min=Stratus.Environment.get("production")?".min":"";Stratus.Components.PropertyMemberList={bindings:{elementId:"@",detailsLinkPopup:"@",detailsLinkUrl:"@",detailsLinkTarget:"@",orderOptions:"@",options:"@",template:"@",variableSync:"@"},controller:["$scope","$attrs","$mdDialog","$window","$timeout","$q","$sce","propertyLoopback",function($scope,$attrs,$mdDialog,$window,$timeout,$q,$sce,propertyLoopback){const $ctrl=this;$ctrl.uid=_.uniqueId("property_member_list_"),Stratus.Instances[$ctrl.uid]=$scope,$scope.elementId=$attrs.elementId||$ctrl.uid,Stratus.Internals.CssLoader(Stratus.BaseUrl+"content/property/stratus/components/propertyMemberList"+min+".css"),$ctrl.$onInit=function(){$scope.urlLoad=!$attrs.urlLoad||!_.isJSON($attrs.urlLoad)||JSON.parse($attrs.urlLoad),$scope.detailsLinkPopup=!$attrs.detailsLinkPopup||!_.isJSON($attrs.detailsLinkPopup)||JSON.parse($attrs.detailsLinkPopup),$scope.detailsLinkUrl=$attrs.detailsLinkUrl||"/property/member/details",$scope.detailsLinkTarget=$attrs.detailsLinkTarget||"_self",$scope.options=$attrs.options&&_.isJSON($attrs.options)?JSON.parse($attrs.options):{},$scope.options.order=$scope.options.order||null,$scope.options.page=$scope.options.page||null,$scope.options.perPage=$scope.options.perPage||25,$scope.options.images=$scope.options.images||{limit:1},$scope.options.where=$scope.options.where||{},$ctrl.defaultOptions=JSON.parse(JSON.stringify($scope.options.where)),propertyLoopback.registerListInstance($scope.elementId,$scope,"Member");$scope.searchMembers({}.Search,!0,!1)},$scope.refreshSearchWidgetOptions=function(){propertyLoopback.getListInstanceLinks($scope.elementId,"Member").forEach(function(searchScope){searchScope.listInitialized=!0})},$scope.searchMembers=async function(options,refresh,updateUrl){return $q(function(resolve,reject){options=options||{},updateUrl=!1!==updateUrl||updateUrl,refresh&&($scope.options.page=1),Object.keys(options).length>0?(delete $scope.options.where,$scope.options.where=options,$scope.options.where.Page&&($scope.options.page=$scope.options.where.Page,delete $scope.options.where.Page),$scope.options.where.Order&&($scope.options.order=$scope.options.where.Order,delete $scope.options.where.Order)):options=$scope.options.where||{},$scope.options.page&&(options.Page=$scope.options.page),options.Page<=1&&delete options.Page,$scope.options.order&&$scope.options.order.length>0&&(options.Order=$scope.options.order),console.log("fetching members:",$scope.options),resolve(propertyLoopback.fetchMembers($scope,"collection",$scope.options,refresh))})},$scope.pageChange=function(pageNumber,ev){ev&&ev.preventDefault(),$scope.options.page=pageNumber,$scope.searchMembers()},$scope.pageNext=function(ev){$scope.options.page||($scope.options.page=1),$scope.collection.completed&&$scope.options.page<$scope.collection.meta.data.totalPages&&$scope.pageChange($scope.options.page+1,ev)},$scope.pagePrevious=function(ev){if($scope.options.page||($scope.options.page=1),$scope.collection.completed&&$scope.options.page>1){let prev=parseInt($scope.options.page)-1||1;$scope.pageChange(prev,ev)}},$scope.orderChange=function(order,ev){ev&&ev.preventDefault(),$scope.options.order=order,$scope.searchMembers(null,!0,!0)},$scope.getMLSDisclaimer=function(html){let disclaimer="";return propertyLoopback.getMLSVariables($scope.options.service||null).forEach(function(service){disclaimer&&(disclaimer+="<br>"),disclaimer+=service.disclaimer}),$scope.collection.meta.data.fetchDate&&(disclaimer=`Last checked ${moment($scope.collection.meta.data.fetchDate).format("M/D/YY")}. ${disclaimer}`),html?$sce.trustAsHtml(disclaimer):disclaimer},$scope.displayMemberDetails=function(member,ev){if(ev&&ev.preventDefault(),!0===$scope.detailsLinkPopup){let templateOptions={element_id:"property_member_detail_popup",service:member._ServiceId,"member-key":member.MemberKey,"page-title":!0};$scope.googleApiKey&&(templateOptions["google-api-key"]=$scope.googleApiKey);let template='<md-dialog aria-label="'+member.MemberKey+'"><stratus-property-member-details ';Object.keys(templateOptions).forEach(function(optionKey){Object.prototype.hasOwnProperty.call(templateOptions, optionKey)&&(template+=optionKey+"='"+templateOptions[optionKey]+"' ")}),template+="></stratus-property-member-details></md-dialog>",$mdDialog.show({template:template,parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,fullscreen:!0}).then(function(){},function(){propertyLoopback.setPageTitle(),$timeout(propertyLoopback.unregisterDetailsInstance("property_member_detail_popup"),10)})}else $window.open($scope.getDetailsURL(property),$scope.detailsLinkTarget)},$scope.injectMemberDetails=function(member,ev){console.log("will add these details to a form",member),$scope.variableInject(member)},$scope.getInput=function(elementId){return angular.element(document.getElementById(elementId))},$scope.variableInject=async function(member){$scope.variableSyncing=$attrs.variableSync&&_.isJSON($attrs.variableSync)?JSON.parse($attrs.variableSync):{};Object.keys($scope.variableSyncing).forEach(function(elementId){let varElement=$scope.getInput(elementId);if(varElement)if(Object.prototype.hasOwnProperty.call(member, $scope.variableSyncing[elementId]))varElement.val(member[$scope.variableSyncing[elementId]]);else if("MemberFullName"===$scope.variableSyncing[elementId]&&Object.prototype.hasOwnProperty.call(member, "MemberFirstName")&&Object.prototype.hasOwnProperty.call(member, "MemberLastName"))varElement.val(member.MemberFirstName+" "+member.MemberLastName);else if("MemberFirstName"===$scope.variableSyncing[elementId]&&!Object.prototype.hasOwnProperty.call(member, "MemberFirstName")&&Object.prototype.hasOwnProperty.call(member, "MemberFullName")){let firstName=member.MemberFullName.split(" ").shift();varElement.val(firstName)}else if("MemberLastName"===$scope.variableSyncing[elementId]&&!Object.prototype.hasOwnProperty.call(member, "MemberLastName")&&Object.prototype.hasOwnProperty.call(member, "MemberFullName")){let nameArray=member.MemberFullName.split(" "),lastName=(nameArray.shift(),nameArray.join(" "));varElement.val(lastName)}})},$scope.remove=function(){}}],templateUrl:function($element,$attrs){let templateMin=!$attrs.templateMin||!_.isJSON($attrs.templateMin)||JSON.parse($attrs.templateMin);return Stratus.BaseUrl+"content/property/stratus/components/"+($attrs.template||"propertyMemberList")+(templateMin&&min)+".html"}}});
