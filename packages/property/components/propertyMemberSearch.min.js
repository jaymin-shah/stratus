!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","lodash","angular","stratus.services.propertyLoopback","stratus.components.propertyMemberList"],factory):factory(root.Stratus,root._,root.angular,root.moment)}(this,function(Stratus,_){const min=Stratus.Environment.get("production")?".min":"";Stratus.Components.PropertyMemberSearch={bindings:{elementId:"@",listId:"@",listLinkUrl:"@",listLinkTarget:"@",options:"@",template:"@",variableSync:"@"},controller:["$scope","$attrs","$window","$timeout","$mdDialog","$q","$mdPanel","propertyLoopback",function($scope,$attrs,$window,$timeout,$mdDialog,$q,$mdPanel,propertyLoopback){this.uid=_.uniqueId("property_member_search_"),Stratus.Instances[this.uid]=$scope,$scope.elementId=$attrs.elementId||this.uid,Stratus.Internals.CssLoader(Stratus.BaseUrl+"content/property/stratus/components/propertyMemberSearch"+min+".css"),this.$onInit=function(){$scope.listId=$attrs.listId||null,$scope.listInitialized=!1,$scope.listLinkUrl=$attrs.listLinkUrl||"/property/member/list",$scope.listLinkTarget=$attrs.listLinkTarget||"_self",$scope.options=$attrs.options&&_.isJSON($attrs.options)?JSON.parse($attrs.options):{},$scope.options.query=$scope.options.query||{},$scope.options.tokenUrl&&propertyLoopback.setTokenURL($scope.options.tokenUrl),propertyLoopback.registerSearchInstance($scope.elementId,$scope,$scope.listId,"Member")},$scope.updateScopeValuePath=async function(scopeVarPath,value){let scopePieces=scopeVarPath.split(".");return $scope.updateNestedPathValue($scope,scopePieces,value)},$scope.updateNestedPathValue=async function(currentNest,pathPieces,value){let currentPiece=pathPieces.shift();return currentPiece&&Object.prototype.hasOwnProperty.call(currentNest, currentPiece)?pathPieces[0]?$scope.updateNestedPathValue(currentNest[currentPiece],pathPieces,value):(_.isArray(currentNest[currentPiece])&&!_.isArray(value)&&(value=""===value?[]:value.split(",")),currentNest[currentPiece]=value,value):null},$scope.getInput=function(elementId){return angular.element(document.getElementById(elementId))},$scope.variableSync=async function(){$scope.variableSyncing=$attrs.variableSync&&_.isJSON($attrs.variableSync)?JSON.parse($attrs.variableSync):{};let promises=[];Object.keys($scope.variableSyncing).forEach(function(elementId){promises.push($q(async function(resolve,reject){let varElement=$scope.getInput(elementId);if(varElement){let scopeVarPath=$scope.variableSyncing[elementId];await $scope.updateScopeValuePath(scopeVarPath,varElement.val()),$scope.$watch(scopeVarPath,function(value){varElement.val(value)},!0)}resolve()}))}),await $q.all(promises)},$scope.searchMembers=function(){let listScope;$scope.listId&&(listScope=propertyLoopback.getListInstance($scope.listId,"Member")),listScope?($scope.options.query.Page=1,listScope.searchMembers($scope.options.query,!0)):(console.log("displaying popup"),$scope.displayMemberSelector())},$scope.displayMemberSelector=function(){let templateOptions={options:{},template:"mothership/propertyMemberSelector","variable-sync":JSON.stringify({agent_fname:"MemberFirstName",agent_lname:"MemberLastName",agent_license:"MemberStateLicense",office_name:"OfficeName",office_id:"OfficeKey"})};if($scope.options.query){let options={service:[$scope.options.service||0],where:$scope.options.query};templateOptions.options=JSON.stringify(options)}let template='<md-dialog aria-label="Property Member Selector" class="transparent"><md-button style="text-align: center" ng-click="ctrl.close()">Close and Accept</md-button><stratus-property-member-list ';Object.keys(templateOptions).forEach(function(optionKey){Object.prototype.hasOwnProperty.call(templateOptions, optionKey)&&(template+=optionKey+"='"+templateOptions[optionKey]+"' ")}),template+="></stratus-property-member-list></md-dialog>",$mdDialog.show({template:template,parent:angular.element(document.body),clickOutsideToClose:!0,fullscreen:!0,controllerAs:"ctrl",controller:function($scope,$mdDialog){let dc=this;function close(){$mdDialog&&$mdDialog.hide()}dc.$onInit=function(){dc.close=close}}}).then(function(){},function(){})}}],templateUrl:function($element,$attrs){return Stratus.BaseUrl+"content/property/stratus/components/"+($attrs.template||"propertyMemberSearch")+min+".html"}}});
