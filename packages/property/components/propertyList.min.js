!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","lodash","angular","moment","angular-sanitize","angular-material","stratus.services.propertyLoopback","stratus.components.propertyDetails"],factory):factory(root.Stratus,root._,root.angular,root.moment)}(this,function(Stratus,_,angular,moment){const min=Stratus.Environment.get("production")?".min":"";Stratus.Components.PropertyList={bindings:{elementId:"@",detailsLinkPopup:"@",detailsLinkUrl:"@",detailsLinkTarget:"@",detailsTemplate:"@",orderOptions:"@",googleApiKey:"@",options:"@",template:"@"},controller:["$scope","$attrs","$mdDialog","$window","$timeout","$q","$sce","propertyLoopback",function($scope,$attrs,$mdDialog,$window,$timeout,$q,$sce,propertyLoopback){const $ctrl=this;$ctrl.uid=_.uniqueId("property_list_"),Stratus.Instances[$ctrl.uid]=$scope,$scope.elementId=$attrs.elementId||$ctrl.uid,Stratus.Internals.CssLoader(Stratus.BaseUrl+"content/property/stratus/components/"+($attrs.template||"propertyList")+min+".css"),$ctrl.$onInit=function(){$scope.urlLoad=!$attrs.urlLoad||!_.isJSON($attrs.urlLoad)||JSON.parse($attrs.urlLoad),$scope.detailsLinkPopup=!$attrs.detailsLinkPopup||!_.isJSON($attrs.detailsLinkPopup)||JSON.parse($attrs.detailsLinkPopup),$scope.detailsLinkUrl=$attrs.detailsLinkUrl||"/property/details",$scope.detailsLinkTarget=$attrs.detailsLinkTarget||"_self",$scope.detailsTemplate=$attrs.detailsTemplate||null,$scope.options=$attrs.options&&_.isJSON($attrs.options)?JSON.parse($attrs.options):{},$scope.options.order=$scope.options.order||null,$scope.options.page=$scope.options.page||null,$scope.options.perPage=$scope.options.perPage||25,$scope.options.images=$scope.options.images||{limit:1},$scope.options.where=$scope.options.where||{},$scope.options.where.City=$scope.options.where.City||"",$scope.options.where.Status=$scope.options.where.Status||["Active","Contract"],$scope.options.where.ListingType=$scope.options.where.ListingType||["House","Condo"],$scope.options.where.AgentLicense=$scope.options.where.AgentLicense||[],$ctrl.defaultOptions=JSON.parse(JSON.stringify($scope.options.where)),$scope.orderOptions=$scope.orderOptions||{"Price (high to low)":"-ListPrice","Price (low to high)":"ListPrice"},$scope.googleApiKey=$attrs.googleApiKey||null,propertyLoopback.registerListInstance($scope.elementId,$scope);let urlOptions={};$scope.urlLoad&&(propertyLoopback.setUrlOptions("Search",JSON.parse(JSON.stringify($ctrl.defaultOptions))),(urlOptions=propertyLoopback.getOptionsFromUrl()).Listing.service&&urlOptions.Listing.ListingKey&&$scope.displayPropertyDetails(urlOptions.Listing)),$scope.searchProperties(urlOptions.Search,!0,!1)},$scope.refreshSearchWidgetOptions=function(){propertyLoopback.getListInstanceLinks($scope.elementId).forEach(function(searchScope){searchScope.setQuery(propertyLoopback.getUrlOptions("Search")),searchScope.listInitialized=!0})},$scope.searchProperties=async function(options,refresh,updateUrl){return $q(function(resolve,reject){options=options||{},updateUrl=!1!==updateUrl||updateUrl,refresh&&($scope.options.page=1),Object.keys(options).length>0?(delete $scope.options.where,$scope.options.where=options,$scope.options.where.Page&&($scope.options.page=$scope.options.where.Page,delete $scope.options.where.Page),$scope.options.where.Order&&($scope.options.order=$scope.options.where.Order,delete $scope.options.where.Order)):options=$scope.options.where||{},$scope.options.page&&(options.Page=$scope.options.page),options.Page<=1&&delete options.Page,$scope.options.order&&$scope.options.order.length>0&&(options.Order=$scope.options.order),propertyLoopback.setUrlOptions("Search",options),updateUrl&&propertyLoopback.refreshUrlOptions($ctrl.defaultOptions),$scope.refreshSearchWidgetOptions(),resolve(propertyLoopback.fetchProperties($scope,"collection",$scope.options,refresh))})},$scope.pageChange=function(pageNumber,ev){ev&&ev.preventDefault(),$scope.options.page=pageNumber,$scope.searchProperties()},$scope.pageNext=function(ev){$scope.options.page||($scope.options.page=1),$scope.collection.completed&&$scope.options.page<$scope.collection.meta.data.totalPages&&$scope.pageChange($scope.options.page+1,ev)},$scope.pagePrevious=function(ev){if($scope.options.page||($scope.options.page=1),$scope.collection.completed&&$scope.options.page>1){let prev=parseInt($scope.options.page)-1||1;$scope.pageChange(prev,ev)}},$scope.orderChange=function(order,ev){ev&&ev.preventDefault(),$scope.options.order=order,$scope.searchProperties(null,!0,!0)},$scope.getDetailsURL=function(property){return $scope.detailsLinkUrl+"#!/Listing/"+property._ServiceId+"/"+property.ListingKey+"/"},$scope.getStreetAddress=function(property){let address="";if(Object.prototype.hasOwnProperty.call(property, "UnparsedAddress")&&""!==property.UnparsedAddress)address=property.UnparsedAddress;else{let addressParts=[];["StreetNumberNumeric","StreetName","StreetSuffix","UnitNumber"].forEach(function(addressPart){Object.prototype.hasOwnProperty.call(property, addressPart)&&("UnitNumber"===addressPart&&addressParts.push("Unit"),addressParts.push(property[addressPart]))}),address=addressParts.join(" ")}return address},$scope.getMLSVariables=function(){return $ctrl.mlsVariables||($ctrl.mlsVariables=propertyLoopback.getMLSVariables()),$ctrl.mlsVariables},$scope.getMLSName=function(serviceId){let services=$scope.getMLSVariables(),name="MLS";return services[serviceId]&&(name=services[serviceId].name),name},$scope.processMLSDisclaimer=function(html){let disclaimer="";return $scope.getMLSVariables().forEach(function(service){disclaimer&&(disclaimer+="<br>"),disclaimer+=service.disclaimer}),$scope.collection.meta.data.fetchDate&&(disclaimer=`Last checked ${moment($scope.collection.meta.data.fetchDate).format("M/D/YY")}. ${disclaimer}`),html?$sce.trustAsHtml(disclaimer):disclaimer},$scope.getMLSDisclaimer=function(html){return $ctrl.disclaimerHTML||($ctrl.disclaimerHTML=$scope.processMLSDisclaimer(!0)),$ctrl.disclaimerString||($ctrl.disclaimerString=$scope.processMLSDisclaimer(!1)),html?$ctrl.disclaimerHTML:$ctrl.disclaimerString},$scope.displayPropertyDetails=function(property,ev){if(ev&&ev.preventDefault(),!0===$scope.detailsLinkPopup){let templateOptions={element_id:"property_detail_popup_"+property.ListingKey,service:property._ServiceId,"listing-key":property.ListingKey,"default-list-options":JSON.stringify($ctrl.defaultOptions),"page-title":!0};$scope.googleApiKey&&(templateOptions["google-api-key"]=$scope.googleApiKey),$scope.detailsTemplate&&(templateOptions.template=$scope.detailsTemplate);let template='<md-dialog aria-label="'+property.ListingKey+'"><stratus-property-details ';Object.keys(templateOptions).forEach(function(optionKey){Object.prototype.hasOwnProperty.call(templateOptions, optionKey)&&(template+=optionKey+"='"+templateOptions[optionKey]+"' ")}),template+="></stratus-property-details></md-dialog>",$mdDialog.show({template:template,parent:angular.element(document.body),targetEvent:ev,clickOutsideToClose:!0,fullscreen:!0}).then(function(){},function(){propertyLoopback.setUrlOptions("Listing",{}),propertyLoopback.refreshUrlOptions($ctrl.defaultOptions),propertyLoopback.setPageTitle(),$timeout(propertyLoopback.unregisterDetailsInstance("property_detail_popup"),10)})}else $window.open($scope.getDetailsURL(property),$scope.detailsLinkTarget)},$scope.remove=function(){}}],templateUrl:function($element,$attrs){return Stratus.BaseUrl+"content/property/stratus/components/"+($attrs.template||"propertyList")+min+".html"}}});
