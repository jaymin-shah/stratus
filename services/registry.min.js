!function(t,e){"function"==typeof define&&define.amd?define(["exports","stratus","underscore","angular","stratus.services.collection","stratus.services.model"],e):e(t.exports,t.Stratus,t._,t.angular,t.Collection,t.Model)}(this,function(t,e,a,o,r,i){let n=function(){console.error("$$interpolate not loaded:",arguments)};class c{constructor(){this.fetch=this.fetch.bind(this)}fetch(t,o){return new Promise(function(r,i){"string"==typeof t&&(t={target:t});const l={target:t.attr?t.attr("data-target"):t.target,targetSuffix:t.attr?t.attr("data-target-suffix"):t.targetSuffix,id:t.attr?t.attr("data-id"):t.id,manifest:t.attr?t.attr("data-manifest"):t.manifest,decouple:t.attr?t.attr("data-decouple"):t.decouple,direct:t.attr?t.attr("data-direct"):t.direct,api:t.attr?t.attr("data-api"):t.api,urlRoot:t.attr?t.attr("data-url-root"):t.urlRoot};let u=0,f=function(){a.isNumber(u)&&u===a.size(l)&&r(c.build(l,o))};a.each(l,function(t,r){if(!t||"string"!=typeof t)return u++,void f();const i=n(t,!1,null,!0),c=i(o.$parent);if(void 0!==c)return l[r]=c,u++,void f();e.Environment.get("production")||console.log("poll attribute:",r),a.poll(function(){return i(o.$parent)},7500,250).then(function(t){e.Environment.get("production")||console.log("interpreted:",t),void 0!==t&&(l[r]=t,u++,f())}).catch(function(t){console.error(t)})})})}static build(t,o){let n;if(t.target){if(t.target=a.ucfirst(t.target),t.manifest||t.id){e.Catalog[t.target]||(e.Catalog[t.target]={});const a=t.id||"manifest";if(t.decouple||!e.Catalog[t.target][a]){const o={target:t.target,manifest:t.manifest,stagger:!0};t.urlRoot&&(o.urlRoot=t.urlRoot),t.targetSuffix&&(o.targetSuffix=t.targetSuffix),n=new i(o,{id:t.id}),t.decouple||(e.Catalog[t.target][a]=n)}else e.Catalog[t.target][a]&&(n=e.Catalog[t.target][a])}else{const a=t.direct?"Compendium":"Catalog";if(e[a][t.target]||(e[a][t.target]={}),t.decouple||!e[a][t.target].collection){const o={target:t.target,direct:!!t.direct};t.urlRoot&&(o.urlRoot=t.urlRoot),t.targetSuffix&&(o.targetSuffix=t.targetSuffix),n=new r(o),t.decouple||(e[a][t.target].collection=n)}else e[a][t.target].collection&&(n=e[a][t.target].collection)}t.api&&n.meta.set("api",a.isJSON(t.api)?JSON.parse(t.api):t.api),n.stagger&&"function"==typeof n.initialize&&n.initialize()}return"object"==typeof n&&null!==n&&(void 0!==o&&(o.data=n,n instanceof i?(o.model=n,"function"==typeof o.$applyAsync&&o.model.on("change",function(){o.$applyAsync()})):n instanceof r&&(o.collection=n)),n.pending||n.completed||n.fetch()),n}}return e.Services.Registry=["$provide",function(t){t.factory("Registry",["$interpolate","Collection","Model",function(t,e,a){return n=t,new c}])}],e.Data.Registry=c,c,c});