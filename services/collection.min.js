!function(t,e){"function"==typeof define&&define.amd?define(["exports","stratus","underscore","angular","stratus.services.model","angular-material"],e):e(t.exports,t.Stratus,t._,t.angular,t.Model)}(this,function(t,e,i,s,n){let o=function(){console.error("$$http not loaded:",arguments)},r=function(){console.error("$$mdToast not loaded:",arguments)};class h{constructor(t){this.target=null,this.direct=!1,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,this.urlRoot="/Api",t&&"object"==typeof t&&s.extend(this,t),this.header=new e.Prototypes.Model,this.meta=new e.Prototypes.Model,this.model=n,this.models=[],this.types=[],this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+i.ucfirst(this.target)),this.serialize=this.serialize.bind(this),this.url=this.url.bind(this),this.inject=this.inject.bind(this),this.sync=this.sync.bind(this),this.fetch=this.fetch.bind(this),this.filter=this.filter.bind(this),this.throttleFilter=this.throttleFilter.bind(this),this.page=this.page.bind(this),this.toJSON=this.toJSON.bind(this),this.add=this.add.bind(this),this.remove=this.remove.bind(this),this.find=this.find.bind(this),this.pluck=this.pluck.bind(this),this.exists=this.exists.bind(this),this.throttle=i.throttle(this.fetch,1e3)}serialize(t,e){const i=this,n=[];return t=t||{},s.forEach(t,function(t,o){if(s.isObject(t))e&&(o=e+"["+o+"]"),n.push(i.serialize(t,o));else{let i="";e&&(i+=e+"["),i+=o,e&&(i+="]"),n.push(i+"="+t)}}),n.join("&")}url(){return this.urlRoot+(this.targetSuffix||"")}inject(t,e){if(!i.isArray(t))return;const s=this;-1===s.types.indexOf(e)&&s.types.push(e),t.forEach(function(t){s.models.push(new n({collection:s,type:e||null},t))})}sync(t,n,r){const h=this;return h.pending=!0,h.completed=!1,new Promise(function(a,c){r=r||{};const l={method:t=t||"GET",url:h.url(),headers:{}};s.isDefined(n)&&("GET"===t?s.isObject(n)&&Object.keys(n).length&&(l.url+=l.url.includes("?")?"&":"?",l.url+=h.serialize(n)):(l.headers["Content-Type"]="application/json",l.data=JSON.stringify(n))),r.hasOwnProperty("headers")&&"object"==typeof r.headers&&Object.keys(r.headers).forEach(function(t){l.headers[t]=r.headers[t]}),o(l).then(function(t){if(200===t.status&&s.isObject(t.data)){h.header.set(t.headers()||{}),h.meta.set(t.data.meta||{}),h.models=[];const e=t.data.payload||t.data;h.direct?h.models=e:i.isArray(e)?h.inject(e):i.isObject(e)?i.each(e,h.inject):console.error("malformed payload:",e),h.pending=!1,h.completed=!0,h.filtering=!1,h.paginate=!1,a(h.models)}else{h.pending=!1,h.error=!0;const s=new e.Prototypes.Error;s.payload=i.isObject(t.data)?t.data:t,t.statusText&&"OK"!==t.statusText?s.message=t.statusText:i.isObject(t.data)?s.message="Unknown AngularCollection error!":s.message=`Invalid Payload: ${l.method} ${l.url}`,c(s)}}).catch(function(t){throw console.error("XHR: "+l.method+" "+l.url),c(t),t})})}fetch(t,e,i){return this.sync(t,e||this.meta.get("api"),i).catch(function(t){r.show(r.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("FETCH:",t)})}filter(t){return this.filtering=!0,this.meta.set("api.q",s.isDefined(t)?t:""),this.meta.set("api.p",1),this.fetch()}throttleFilter(t){const i=this;return i.meta.set("api.q",s.isDefined(t)?t:""),new Promise(function(t,s){const n=i.throttle();e.Environment.get("production")||console.log("request:",n),n.then(function(i){e.Environment.get("production"),t(i)}).catch(s)})}page(t){this.paginate=!0,this.meta.set("api.p",t),this.fetch(),delete this.meta.get("api").p}toJSON(){const t=[];return this.models.forEach(function(e){"function"==typeof e.toJSON&&t.push(e.toJSON())}),t}add(t,e){if(!s.isObject(t))return;e&&"object"==typeof e||(e={});t=t instanceof n?t:new n({collection:this},t),this.models.push(t),e.save&&t.save()}remove(t){this.models.splice(this.models.indexOf(t),1)}find(t){return i.find(this.models,i.isFunction(t)?t:function(e){return e.get("id")===t})}pluck(t){return i.map(this.models,function(e){return e instanceof n?e.pluck(t):null})}exists(t){return!!i.reduce(this.pluck(t)||[],function(t,e){return t||s.isDefined(e)})}}return e.Services.Collection=["$provide",function(t){t.factory("Collection",["$http","$mdToast",function(t,e){return o=t,r=e,h}])}],e.Data.Collection=h,h,h});